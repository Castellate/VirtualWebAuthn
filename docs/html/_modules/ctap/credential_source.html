

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>ctap.credential_source &mdash; Virtual WebAuthN Authenticator  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Virtual WebAuthN Authenticator
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Virtual WebAuthN Authenticator</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ctap.credential_source</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ctap.credential_source</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Provides a class to manage a credential source</span>

<span class="sd">Classes:</span>

<span class="sd"> * :class:`PublicKeyCredentialSource`</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"> Â© Copyright 2020-2021 University of Surrey</span>

<span class="sd"> Redistribution and use in source and binary forms, with or without</span>
<span class="sd"> modification, are permitted provided that the following conditions are met:</span>

<span class="sd"> 1. Redistributions of source code must retain the above copyright notice,</span>
<span class="sd"> this list of conditions and the following disclaimer.</span>

<span class="sd"> 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="sd"> this list of conditions and the following disclaimer in the documentation</span>
<span class="sd"> and/or other materials provided with the distribution.</span>

<span class="sd"> THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="sd"> AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="sd"> IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="sd"> ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE</span>
<span class="sd"> LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="sd"> CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="sd"> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="sd"> INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="sd"> CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="sd"> ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="sd"> POSSIBILITY OF SUCH DAMAGE.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">crypto.crypto_provider</span> <span class="k">import</span> <span class="p">(</span><span class="n">AuthenticatorCryptoKeyPair</span><span class="p">,</span>
    <span class="n">CRYPTO_PROVIDERS</span><span class="p">,</span><span class="n">AuthenticatorCryptoPrivateKey</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ctap.constants</span> <span class="k">import</span> <span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_DESCRIPTOR</span>
<span class="kn">from</span> <span class="nn">ctap.constants</span> <span class="k">import</span> <span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_USER_ENTITY</span>
<span class="kn">from</span> <span class="nn">ctap.constants</span> <span class="k">import</span> <span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span>
<span class="kn">from</span> <span class="nn">authenticator.datatypes</span> <span class="k">import</span> <span class="n">PublicKeyCredentialRpEntity</span>
<span class="kn">import</span> <span class="nn">ctap.constants</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="PublicKeyCredentialSource"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource">[docs]</a><span class="k">class</span> <span class="nc">PublicKeyCredentialSource</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Manages a PublicKeyCredentialSource</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes a new PublicKeyCredentialSource with default values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="o">=</span><span class="s2">&quot;public-key&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rp_entity</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sk</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keypair</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_handle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_other_ui</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signature_counter</span><span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_bytes</span><span class="o">=</span><span class="kc">None</span>
        <span class="c1">#TODO Add random alias so we don&#39;t use the RP name as the TPM Key, possibly in here or as an addition to the TPM class</span>
<div class="viewcode-block" id="PublicKeyCredentialSource.init_new"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.init_new">[docs]</a>    <span class="k">def</span> <span class="nf">init_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alg</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">key_pair</span><span class="p">:</span><span class="n">AuthenticatorCryptoKeyPair</span><span class="p">,</span>
        <span class="n">rp_entity</span><span class="p">:</span><span class="s1">&#39;PublicKeyCredentialRpEntity&#39;</span><span class="p">,</span> <span class="n">user_entity</span><span class="p">:</span><span class="s1">&#39;PublicKeyCredentialUserEntity&#39;</span><span class="p">,</span>
        <span class="n">keytype</span><span class="o">=</span><span class="s2">&quot;public-key&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initalises a new credential source, generating a new channel ID. This should</span>
<span class="sd">        be called when creating new credential sources only, not when reloading a</span>
<span class="sd">        previously generated one</span>

<span class="sd">        Args:</span>
<span class="sd">            alg (int): COSE algorithm for this credential source</span>
<span class="sd">            key_pair (AuthenticatorCryptoKeyPair): Crypto key pair for credential</span>
<span class="sd">            rp_id (PublicKeyCredentialRpEntity): Relying Party entity</span>
<span class="sd">            user_entity (PublicKeyCredentialUserEntity): User Entity</span>
<span class="sd">            keytype (str, optional): type. Defaults to &quot;public-key&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alg</span><span class="o">=</span><span class="n">alg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="o">=</span><span class="n">keytype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rp_entity</span> <span class="o">=</span> <span class="n">rp_entity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keypair</span> <span class="o">=</span> <span class="n">key_pair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_handle</span> <span class="o">=</span> <span class="n">user_entity</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
        <span class="n">other_ui</span> <span class="o">=</span> <span class="n">user_entity</span><span class="o">.</span><span class="n">get_as_dict</span><span class="p">()</span>
        <span class="n">other_ui</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_USER_ENTITY</span><span class="o">.</span><span class="n">ID</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_other_ui</span><span class="o">=</span><span class="n">other_ui</span></div>
<div class="viewcode-block" id="PublicKeyCredentialSource.generate_id"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.generate_id">[docs]</a>    <span class="k">def</span> <span class="nf">generate_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates a new random credential ID of size CREDENTIAL_ID_SIZE and</span>
<span class="sd">        sets its value to _id in this credential source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="n">ctap</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">CREDENTIAL_ID_SIZE</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_alg"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_alg">[docs]</a>    <span class="k">def</span> <span class="nf">get_alg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the algorithm for this credential</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: COSE algorithm identifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alg</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_bytes"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">without_id</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructs a JSON object containing the data associated with</span>
<span class="sd">        this credential source and encodes the JSON String as bytes. This should</span>
<span class="sd">        be used for storing the credential source to disk or when</span>
<span class="sd">        the credential source is going to be wrapped and set on the server,</span>
<span class="sd">        for example, a non-resident key.</span>

<span class="sd">        without_id allows excluding the ID parameter, which in the case of a</span>
<span class="sd">        non-resident key will be the wrapped encrypted data itself.</span>

<span class="sd">        Args:</span>
<span class="sd">            without_id (bool, optional): If set to True excludes the ID from the</span>
<span class="sd">                data. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: [description]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">TYPE</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">without_id</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">ID</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">ALG</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alg</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">RP_ID</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rp_entity</span><span class="o">.</span><span class="n">get_as_dict</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">USER_HANDLE</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_handle</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">OTHER_UI</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_ui</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">SIGNATURE_COUNTER</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signature_counter</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">KEY_PAIR</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_keypair</span><span class="o">.</span><span class="n">get_encoded</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.debug"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.debug">[docs]</a>    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructs a JSON str of the data within this credential</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: json debug object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">TYPE</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">ID</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">ALG</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alg</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">RP_ID</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rp_entity</span><span class="o">.</span><span class="n">get_as_dict</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">USER_HANDLE</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_handle</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">OTHER_UI</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_ui</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">SIGNATURE_COUNTER</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signature_counter</span>
        <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">KEY_PAIR</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_keypair</span><span class="o">.</span><span class="n">get_encoded</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_public_key_credential_descriptor"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_public_key_credential_descriptor">[docs]</a>    <span class="k">def</span> <span class="nf">get_public_key_credential_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a dictionary containing the public key</span>
<span class="sd">        credential description, consisting of the credential</span>
<span class="sd">        ID and the type.</span>

<span class="sd">        The optional transports parameter is currently not set</span>
<span class="sd">        but could be.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: containing credential ID and type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#PublicKeyCredentialDescriptor</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">desc</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_DESCRIPTOR</span><span class="o">.</span><span class="n">ID</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
        <span class="n">desc</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_DESCRIPTOR</span><span class="o">.</span><span class="n">TYPE</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">=</span>\
            <span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_DESCRIPTOR</span><span class="o">.</span><span class="n">TYPE_PUBLIC_KEY</span><span class="o">.</span><span class="n">value</span>
        <span class="c1">#desc[&quot;transports&quot;]=[&quot;usb&quot;]</span>
        <span class="k">return</span> <span class="n">desc</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.from_bytes"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.from_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">from_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">:</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">without_id</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads a credential source from bytes. This should be called when</span>
<span class="sd">        reloading a credential source from storage or after decrypting</span>
<span class="sd">        a non-resident key.</span>

<span class="sd">        without_id is used to indicate whether the id attribute should</span>
<span class="sd">        be set, in the case of a non-resident key this should be True</span>
<span class="sd">        due to the id being the encrypted contents of this.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (bytes): bytes to load</span>
<span class="sd">            without_id (bool, optional): True to exclude the ID (non-resident</span>
<span class="sd">            key), False to set the ID. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_bytes</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">TYPE</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">without_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">ID</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">ALG</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rp_entity</span> <span class="o">=</span> <span class="n">PublicKeyCredentialRpEntity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">RP_ID</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signature_counter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">SIGNATURE_COUNTER</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keypair</span><span class="o">=</span><span class="n">CRYPTO_PROVIDERS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_alg</span><span class="p">]</span><span class="o">.</span><span class="n">load_key_pair</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">KEY_PAIR</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_handle</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">USER_HANDLE</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_other_ui</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_SOURCE</span><span class="o">.</span><span class="n">OTHER_UI</span><span class="o">.</span><span class="n">value</span><span class="p">]</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_loaded_bytes"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_loaded_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_loaded_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the bytes that were originally loaded for this credential source or None</span>
<span class="sd">        if it is new. This is used to index and updated stored credential sources</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: Original bytes loaded into the credential source or None if new</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_bytes</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_cose_public_key"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_cose_public_key">[docs]</a>    <span class="k">def</span> <span class="nf">get_cose_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encodes the public key in a COSE compatible format</span>

<span class="sd">        Returns:</span>
<span class="sd">            cose: COSE encoded public key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keypair</span><span class="o">.</span><span class="n">get_public_key</span><span class="p">()</span><span class="o">.</span><span class="n">get_as_cose</span><span class="p">()</span></div>


<div class="viewcode-block" id="PublicKeyCredentialSource.get_signature_counter_bytes"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_signature_counter_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_signature_counter_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the signatures counter as bytes</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: signature counter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_signature_counter</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_private_key"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_private_key">[docs]</a>    <span class="k">def</span> <span class="nf">get_private_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">AuthenticatorCryptoPrivateKey</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the private key</span>

<span class="sd">        Returns:</span>
<span class="sd">            AuthenticatorCryptoPrivateKey: private key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keypair</span><span class="o">.</span><span class="n">get_private_key</span><span class="p">()</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_signature_counter"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_signature_counter">[docs]</a>    <span class="k">def</span> <span class="nf">get_signature_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the signature counter as an integer</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: integer encoded signature counter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_signature_counter</span><span class="p">),</span><span class="s2">&quot;big&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.increment_signature_counter"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.increment_signature_counter">[docs]</a>    <span class="k">def</span> <span class="nf">increment_signature_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increments the signature counter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signature_counter</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_signature_counter</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.set_id"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.set_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span><span class="nb">bytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the credential id</span>

<span class="sd">        Args:</span>
<span class="sd">            user_id (bytes): id to set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">user_id</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_id"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the credential id</span>

<span class="sd">        Returns:</span>
<span class="sd">            bytes: credential id as bytes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.set_private_key"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.set_private_key">[docs]</a>    <span class="k">def</span> <span class="nf">set_private_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">:</span><span class="n">AuthenticatorCryptoPrivateKey</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the private key to private_key</span>

<span class="sd">        Args:</span>
<span class="sd">            private_key (AuthenticatorCryptoPrivateKey): private key to set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sk</span> <span class="o">=</span> <span class="n">private_key</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.set_type"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.set_type">[docs]</a>    <span class="k">def</span> <span class="nf">set_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cred_type</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the type for this credential</span>

<span class="sd">        Args:</span>
<span class="sd">            cred_type (str): credential type, normally public-key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">cred_type</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_type"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the type of this credential</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: credential type, usually public-key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.set_rp_entity"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.set_rp_entity">[docs]</a>    <span class="k">def</span> <span class="nf">set_rp_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rp_entity</span><span class="p">:</span><span class="s1">&#39;PublicKeyCredentialRpEntity&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the rp entity</span>

<span class="sd">        Args:</span>
<span class="sd">            rp_entity (PublicKeyCredentialRpEntity): RP entity to set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rp_entity</span> <span class="o">=</span> <span class="n">rp_entity</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_rp_entity"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_rp_entity">[docs]</a>    <span class="k">def</span> <span class="nf">get_rp_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="s1">&#39;PublicKeyCredentialRpEntity&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the associated RP Entity</span>

<span class="sd">        Returns:</span>
<span class="sd">            PublicKeyCredentialRpEntity: rp entity associated with credential source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rp_entity</span></div>
<div class="viewcode-block" id="PublicKeyCredentialSource.set_user_handle"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.set_user_handle">[docs]</a>    <span class="k">def</span> <span class="nf">set_user_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_handle</span><span class="p">:</span><span class="nb">bytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the user handle</span>

<span class="sd">        Args:</span>
<span class="sd">            user_handle (bytes): user handle to set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_handle</span><span class="o">=</span><span class="n">user_handle</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_user_entity"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_user_entity">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_identifiable</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the user entity for this credential source</span>

<span class="sd">        if include_identifiable is set it will include user identifiable</span>
<span class="sd">        information in the dictionary (other_ui), otherwise it will not</span>

<span class="sd">        Args:</span>
<span class="sd">            include_identifiable (bool, optional): set to True to include</span>
<span class="sd">                user identifiable information. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: contain a minimum of the user handle (id) and possibly</span>
<span class="sd">                other_ui as well</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">include_identifiable</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_ui</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_USER_ENTITY</span><span class="o">.</span><span class="n">ID</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_handle</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="n">result</span><span class="p">[</span><span class="n">AUTHN_PUBLIC_KEY_CREDENTIAL_USER_ENTITY</span><span class="o">.</span><span class="n">ID</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_handle</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.set_other_ui"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.set_other_ui">[docs]</a>    <span class="k">def</span> <span class="nf">set_other_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_ui</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the other UI components</span>

<span class="sd">        Args:</span>
<span class="sd">            other_ui (dict): dictionary of other UI data from the user entity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_other_ui</span> <span class="o">=</span> <span class="n">other_ui</span></div>

<div class="viewcode-block" id="PublicKeyCredentialSource.get_other_ui"><a class="viewcode-back" href="../../ctap.html#ctap.credential_source.PublicKeyCredentialSource.get_other_ui">[docs]</a>    <span class="k">def</span> <span class="nf">get_other_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets the other UI components from the user entity</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: containing other ui elements</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_ui</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020-2021, University of Surrey.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>